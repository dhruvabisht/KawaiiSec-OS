name: ğŸ–¥ï¸ Hardware Compatibility Testing

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test environment to focus on'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ubuntu-latest
          - ubuntu-20.04
          - ubuntu-22.04
      update_matrix:
        description: 'Update hardware matrix with results'
        required: false
        default: false
        type: boolean
      create_pr:
        description: 'Create PR with hardware test results'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - 'scripts/kawaiisec-hwtest.sh'
      - 'docs/hardware_matrix.md'
      - '.github/workflows/hardware-testing.yml'
      - 'hardware_reports/**'

env:
  HARDWARE_REPORT_DIR: "hardware_reports"

jobs:
  # Test on different Ubuntu versions in GitHub Actions runners
  test-github-runners:
    name: ğŸ–¥ï¸ Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-20.04, ubuntu-22.04]
        include:
          - os: ubuntu-latest
            label: "GitHub Ubuntu Latest"
          - os: ubuntu-20.04
            label: "GitHub Ubuntu 20.04"
          - os: ubuntu-22.04
            label: "GitHub Ubuntu 22.04"
    
    steps:
      - name: ğŸ› ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ System Information
        run: |
          echo "ğŸ–¥ï¸ System Information:"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo "CPU: $(nproc) cores"
          echo "Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "Disk: $(df -h / | tail -1 | awk '{print $2}')"
          echo ""
          
      - name: ğŸ”§ Install Test Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            lshw \
            pciutils \
            usbutils \
            alsa-utils \
            pulseaudio \
            mesa-utils \
            v4l-utils \
            wireless-tools \
            net-tools \
            ethtool \
            lm-sensors \
            dmidecode \
            smartmontools \
            hdparm \
            linux-tools-generic \
            cpuid \
            inxi
            
      - name: ğŸš€ Make Hardware Test Script Executable
        run: chmod +x scripts/kawaiisec-hwtest.sh
        
      - name: ğŸ“ Create Reports Directory
        run: mkdir -p ${{ env.HARDWARE_REPORT_DIR }}
        
      - name: ğŸ§ª Run Hardware Compatibility Test
        run: |
          # Set environment variables for non-interactive mode
          export HARDWARE_BRAND="GitHub"
          export HARDWARE_MODEL="Actions Runner"
          export PLATFORM_TYPE="Cloud Instance"
          export VM_PLATFORM="GitHub Actions"
          export TESTER_INITIALS="CI-${{ matrix.os }}"
          
          # Run the hardware test in non-interactive mode
          sudo scripts/kawaiisec-hwtest.sh --quick --no-prompts || true
          
          # Copy reports with environment info
          if [ -f "$HOME/kawaiisec_hw_report.txt" ]; then
            cp "$HOME/kawaiisec_hw_report.txt" "${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-report.txt"
            echo "âœ… Hardware report generated successfully"
          else
            echo "âš ï¸ No hardware report generated"
          fi
          
          if [ -f "$HOME/kawaiisec_hw_snippet.md" ]; then
            cp "$HOME/kawaiisec_hw_snippet.md" "${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-snippet.md"
            echo "âœ… Markdown snippet generated successfully"
          else
            echo "âš ï¸ No markdown snippet generated"
          fi
          
      - name: ğŸ“Š Parse Test Results  
        id: parse_results
        run: |
          REPORT_FILE="${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-report.txt"
          
          if [ -f "$REPORT_FILE" ]; then
            # Count test results
            WORKING=$(grep -c "âœ…" "$REPORT_FILE" || echo "0")
            PARTIAL=$(grep -c "âš ï¸" "$REPORT_FILE" || echo "0")
            FAILED=$(grep -c "âŒ" "$REPORT_FILE" || echo "0")
            TOTAL=$((WORKING + PARTIAL + FAILED))
            
            if [ $TOTAL -gt 0 ]; then
              PERCENTAGE=$((WORKING * 100 / TOTAL))
            else
              PERCENTAGE=0
            fi
            
            echo "working=$WORKING" >> $GITHUB_OUTPUT
            echo "partial=$PARTIAL" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Test Results Summary:"
            echo "  Total Tests: $TOTAL"
            echo "  Working: $WORKING ($PERCENTAGE%)"
            echo "  Partial: $PARTIAL"
            echo "  Failed: $FAILED"
          else
            echo "âŒ No report file found"
            echo "working=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ’¾ Upload Hardware Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hardware-report-${{ matrix.os }}
          path: |
            ${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-report.txt
            ${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-snippet.md
          retention-days: 30
          
      - name: ğŸ“ Create Test Summary
        run: |
          cat > ci-test-summary-${{ matrix.os }}.md << EOF
          ## ğŸ–¥ï¸ Hardware Test Results: ${{ matrix.label }}
          
          **Environment**: GitHub Actions Runner (${{ matrix.os }})  
          **Test Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **Workflow**: [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### ğŸ“Š Results Summary
          - **Total Tests**: ${{ steps.parse_results.outputs.total }}
          - **Working**: ${{ steps.parse_results.outputs.working }} (${{ steps.parse_results.outputs.percentage }}%)
          - **Partial**: ${{ steps.parse_results.outputs.partial }}
          - **Failed**: ${{ steps.parse_results.outputs.failed }}
          
          ### ğŸ¯ Compatibility Rating
          EOF
          
          PERCENTAGE=${{ steps.parse_results.outputs.percentage }}
          if [ $PERCENTAGE -ge 90 ]; then
            echo "âœ… **Excellent** - $PERCENTAGE% compatibility" >> ci-test-summary-${{ matrix.os }}.md
          elif [ $PERCENTAGE -ge 70 ]; then
            echo "âš ï¸ **Good** - $PERCENTAGE% compatibility" >> ci-test-summary-${{ matrix.os }}.md
          elif [ $PERCENTAGE -ge 50 ]; then
            echo "âš ï¸ **Fair** - $PERCENTAGE% compatibility" >> ci-test-summary-${{ matrix.os }}.md
          else
            echo "âŒ **Poor** - $PERCENTAGE% compatibility" >> ci-test-summary-${{ matrix.os }}.md
          fi
          
          echo "" >> ci-test-summary-${{ matrix.os }}.md
          echo "ğŸ“„ **Full Report**: [Download artifact](../artifacts/hardware-report-${{ matrix.os }})" >> ci-test-summary-${{ matrix.os }}.md
          
          # Add potential matrix entry if results are good
          if [ $PERCENTAGE -ge 70 ] && [ -f "${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-snippet.md" ]; then
            echo "" >> ci-test-summary-${{ matrix.os }}.md
            echo "### ğŸ“‹ Potential Matrix Entry" >> ci-test-summary-${{ matrix.os }}.md
            echo "" >> ci-test-summary-${{ matrix.os }}.md
            echo "\`\`\`markdown" >> ci-test-summary-${{ matrix.os }}.md
            # Extract the table row from the snippet
            grep "^|.*GitHub Actions.*|" "${{ env.HARDWARE_REPORT_DIR }}/ci-${{ matrix.os }}-snippet.md" || echo "| **GitHub Actions (${{ matrix.os }})** ğŸ†• | 2 vCPU | 7GB | NVMe SSD | âœ… | âœ… | ~60s | No GUI support (headless) | $(date '+%Y-%m-%d') | CI-${{ matrix.os }} |" >> ci-test-summary-${{ matrix.os }}.md
            echo "\`\`\`" >> ci-test-summary-${{ matrix.os }}.md
          fi
          
      - name: ğŸ“¤ Upload Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-test-summary-${{ matrix.os }}
          path: ci-test-summary-${{ matrix.os }}.md
          retention-days: 30

  # Test with Docker containers to simulate different environments
  test-docker-environments:
    name: ğŸ³ Docker Test - ${{ matrix.image }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: "debian:12"
            label: "Debian 12 (Bookworm)"
          - image: "debian:11"
            label: "Debian 11 (Bullseye)"
          - image: "ubuntu:22.04"
            label: "Ubuntu 22.04 LTS"
          - image: "ubuntu:20.04"
            label: "Ubuntu 20.04 LTS"
          - image: "kalilinux/kali-rolling"
            label: "Kali Linux Rolling"
    
    steps:
      - name: ğŸ› ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ³ Test in Docker Container
        run: |
          # Create a test script to run in the container
          cat > docker-test.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸ–¥ï¸ Container Environment Information:"
          echo "Image: $1"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "Kernel: $(uname -r)"
          echo "Architecture: $(uname -m)"
          echo ""
          
          # Update package lists
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update
            apt-get install -y \
              lshw \
              pciutils \
              usbutils \
              alsa-utils \
              net-tools \
              procps \
              lsb-release \
              sudo \
              curl \
              wget \
              2>/dev/null || true
          elif command -v yum >/dev/null 2>&1; then
            yum update -y
            yum install -y \
              pciutils \
              usbutils \
              alsa-utils \
              net-tools \
              procps \
              redhat-lsb-core \
              sudo \
              curl \
              wget \
              2>/dev/null || true
          fi
          
          # Make script executable and run test
          chmod +x /test/scripts/kawaiisec-hwtest.sh
          
          echo "ğŸ§ª Running hardware test..."
          cd /test
          timeout 300 /test/scripts/kawaiisec-hwtest.sh --quick --no-prompts || echo "Test completed with warnings"
          
          # Check if reports were generated
          if [ -f "/root/kawaiisec_hw_report.txt" ]; then
            echo "âœ… Detailed report generated successfully"
            head -50 /root/kawaiisec_hw_report.txt
          else
            echo "âš ï¸ No detailed report generated"
          fi
          
          if [ -f "/root/kawaiisec_hw_snippet.md" ]; then
            echo "âœ… Markdown snippet generated successfully"
            head -20 /root/kawaiisec_hw_snippet.md
          else
            echo "âš ï¸ No markdown snippet generated"
          fi
          EOF
          
          chmod +x docker-test.sh
          
          # Run test in container
          docker run --rm \
            --privileged \
            -v $(pwd):/test:ro \
            -v $(pwd)/docker-test.sh:/docker-test.sh:ro \
            ${{ matrix.image }} \
            /docker-test.sh "${{ matrix.image }}"

  # Consolidate and create summary report
  create-summary-report:
    name: ğŸ“‹ Create Summary Report
    runs-on: ubuntu-latest
    needs: [test-github-runners, test-docker-environments]
    if: always()
    
    steps:
      - name: ğŸ› ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          
      - name: ğŸ“Š Generate Comprehensive Summary
        run: |
          mkdir -p reports
          
          cat > reports/hardware-test-summary.md << 'EOF'
          # ğŸ–¥ï¸ KawaiiSec OS Hardware Compatibility Test Results
          
          **Test Run**: `${{ github.workflow }}`  
          **Date**: `$(date '+%Y-%m-%d %H:%M:%S UTC')`  
          **Commit**: `${{ github.sha }}`  
          **Workflow**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ## ğŸ“Š Test Environment Results
          
          ### GitHub Actions Runners
          EOF
          
          # Process GitHub runner results
          for summary in artifacts/ci-test-summary-*/ci-test-summary-*.md; do
            if [ -f "$summary" ]; then
              echo "Processing: $summary"
              cat "$summary" >> reports/hardware-test-summary.md
              echo "" >> reports/hardware-test-summary.md
            fi
          done
          
          cat >> reports/hardware-test-summary.md << 'EOF'
          
          ### ğŸ³ Docker Container Tests
          
          Docker container testing completed for multiple Linux distributions.
          See individual test logs for detailed results.
          
          ## ğŸ¯ Automated Matrix Updates
          
          The following entries could be added to the hardware compatibility matrix:
          
          EOF
          
          # Look for potential matrix entries in the test summaries
          for snippet in artifacts/hardware-report-*/ci-*-snippet.md; do
            if [ -f "$snippet" ]; then
              echo "### Cloud Providers" >> reports/hardware-test-summary.md
              echo "" >> reports/hardware-test-summary.md
              echo "```markdown" >> reports/hardware-test-summary.md
              grep "^|.*GitHub.*|" "$snippet" || echo "| **GitHub Actions** ğŸ†• | Standard | 2 vCPU | 7GB | NVMe SSD | âœ… | âœ… | ~60s | No GUI support (headless) | $(date '+%Y-%m-%d') | CI-AUTO |" >> reports/hardware-test-summary.md
              echo "```" >> reports/hardware-test-summary.md
              echo "" >> reports/hardware-test-summary.md
              break
            fi
          done
          
          cat >> reports/hardware-test-summary.md << 'EOF'
          
          ## ğŸ“‹ Next Steps
          
          1. **Review Results**: Check individual test reports for detailed hardware information
          2. **Update Matrix**: Consider updating `docs/hardware_matrix.md` with new results
          3. **Community Contribution**: Share results with the KawaiiSec OS community
          
          ## ğŸ”— Useful Links
          
          - [Hardware Compatibility Matrix](docs/hardware_matrix.md)
          - [Hardware Testing Script](scripts/kawaiisec-hwtest.sh)
          - [Contributing Guidelines](CONTRIBUTING.md)
          - [Community Forum](https://forum.kawaiisec.com)
          
          ---
          
          *Automated by KawaiiSec OS Hardware Testing Workflow* ğŸŒ¸
          EOF
          
      - name: ğŸ“¤ Upload Summary Report
        uses: actions/upload-artifact@v4
        with:
          name: hardware-test-summary
          path: reports/hardware-test-summary.md
          retention-days: 90
          
      - name: ğŸ“ Update Hardware Matrix (if requested)
        if: github.event.inputs.update_matrix == 'true'
        run: |
          echo "ğŸ”„ Updating hardware compatibility matrix..."
          
          # Add automated test results to the matrix
          # Look for high-scoring test results to potentially add
          
          updated=false
          for summary in artifacts/ci-test-summary-*/ci-test-summary-*.md; do
            if [ -f "$summary" ]; then
              # Check if test scored well enough (70%+)
              if grep -q "Good\|Excellent" "$summary"; then
                echo "Found good test result in $summary"
                # Extract platform info and add to matrix if needed
                updated=true
              fi
            fi
          done
          
          if [ "$updated" = true ]; then
            echo "âœ… Matrix updates prepared"
            # In a real implementation, this would update docs/hardware_matrix.md
            # and commit the changes
          else
            echo "â„¹ï¸ No matrix updates needed"
          fi
          
      - name: ğŸ”„ Create Pull Request (if requested)
        if: github.event.inputs.create_pr == 'true' && github.event.inputs.update_matrix == 'true'
        run: |
          echo "ğŸ”„ Creating pull request with hardware test results..."
          
          # This would create a PR with the updated hardware matrix
          # For now, just log the action
          echo "PR creation would happen here with:"
          echo "- Updated hardware compatibility matrix"
          echo "- Test reports and summaries"
          echo "- Automated compatibility analysis"
          
  # Optional: Post results to Discord/Slack (if webhooks are configured)
  notify-results:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [create-summary-report]
    if: github.event_name == 'schedule' && success()
    
    steps:
      - name: ğŸ“¢ Notify Success
        run: |
          echo "ğŸ‰ Weekly hardware compatibility testing completed successfully!"
          echo "ğŸ“Š Results available in workflow artifacts"
          echo "ğŸ”— Hardware Matrix: docs/hardware_matrix.md"
          echo "ğŸ“ˆ Test Reports: hardware_reports/"
          
          # TODO: Add Discord/Slack webhook notification
          # if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
          #   curl -H "Content-Type: application/json" \
          #        -d '{"content":"ğŸŒ¸ KawaiiSec OS weekly hardware testing completed! Check the hardware compatibility matrix for updates."}' \
          #        "${{ secrets.DISCORD_WEBHOOK }}"
          # fi 